<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Quiz Master</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --success: #22c55e; --error: #ef4444; --gray: #64748b; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 700px; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.08); min-height: 450px; display: flex; flex-direction: column; position: relative; }
        .hidden { display: none !important; }
        
        h2 { text-align: center; color: var(--primary); margin-bottom: 1.5rem; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* ボタンと説明 */
        .mode-group { margin-bottom: 15px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; width: 100%; margin: 0; }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .mode-desc { font-size: 0.8rem; color: var(--gray); margin-top: 4px; margin-left: 4px; line-height: 1.4; }

        .btn-nav { background: var(--gray); color: white; width: auto; min-width: 100px; }
        .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; }

        /* クイズ画面 */
        .question-container { position: relative; margin: 30px 0; }
        .question-text { font-size: 1.2rem; line-height: 2.2; color: #334155; padding-right: 40px; }
        .hint-trigger {
            position: absolute; right: 0; top: 0; width: 30px; height: 30px;
            background: #e2e8f0; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-weight: bold; color: var(--gray);
        }

        .blank-box {
            display: inline-block; min-width: 100px; height: 2.2rem; background: #fff;
            border: 2px solid #cbd5e1; border-radius: 6px; vertical-align: middle;
            margin: 0 4px; cursor: pointer; text-align: center; line-height: 2.2rem;
            font-weight: bold; color: var(--primary); transition: 0.2s;
        }
        .blank-box.filled { border-color: var(--primary); background: #eff6ff; }

        .nav-controls { display: flex; justify-content: space-between; margin-top: auto; padding-top: 20px; }
        .status-header { display: flex; justify-content: space-between; font-size: 0.9rem; color: #94a3b8; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

        /* モーダル */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--gray); }
        .choice-item { width: 100%; text-align: left; padding: 12px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="app" class="card"></div>
</div>

<div id="choice-overlay" class="overlay" onclick="closeModal('choice-overlay')">
    <div class="modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal('choice-overlay')">&times;</span>
        <h3 style="margin-top:0">回答を選択</h3>
        <div id="choices-list"></div>
    </div>
</div>

<div id="hint-overlay" class="overlay" onclick="closeModal('hint-overlay')">
    <div class="modal" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal('hint-overlay')">&times;</span>
        <h3 style="margin-top:0; color: var(--primary);">ヒント</h3>
        <p id="hint-text" style="line-height: 1.6; color: #475569;"></p>
    </div>
</div>

<script>
const quizData = [
    { id: 1, q: "懸賞を用いた販売促進では、誰にでも当選の可能性のある「 」キャンペーンと特定の条件を満たした人のみが当たる可能性のある「 」キャンペーンがある。", a: ["オープン", "クローズト"] },
    { id: 3, q: "従来の顧客創造型マーケティングとは異なり、新規顧客を開拓するよりも既存の顧客を効率的であり、高収益につながるという考え方に基づくマーケティングを「 」型マーケティングという。", a: ["顧客維持"] },
    { id: 4, q: "既存顧客からの収益アップのしくみは、「 」利益、「 」利益、「 」利益、「 」利益、「 」利益がある。", a: ["基礎", "購買・残高増", "営業費削減", "紹介", "価格プレミアム"] },
    { id: 9, q: "顧客一人ひとりを把握することを前提にしたマーケティングを「 」マーケティングという。", a: ["ワン・トゥ・ワン"] },
    { id: 10, q: "サービスマーケティングの4つの特徴は、「 」、「 」、「 」、「 」である。", a: ["無形性", "同時性", "異質性", "消滅性"] },
    { id: 14, q: "サービスを4種類に分類すると「 」サービス、「 」サービス、「 」サービス、「 」サービスである。", a: ["パーソン・スタンダード", "パーソン・カスタマイズ", "マテリアル・スタンダード", "マテリアル・カスタマイズ"] },
    { id: 18, q: "サービスパッケージの5つの要素は、「 」、「 」、「 」、「 」、「 」である。", a: ["基本サービス", "付加的サービス", "ブランド", "設備", "物的提供物"] },
    { id: 23, q: "従来の４P（PRODUCT/PRICE/PLACE/PROMOTION)に加えて７Pと言われる追加の３Pは「 」、「 」、「 」である。", a: ["people", "process", "physical evidence"] },
    { id: 26, q: "従業員を顧客の一部とみて、ニーズを満たし、好ましい行動を引き出そうとする活動を「 」マーケティングという。", a: ["インターナル"] },
    { id: 27, q: "限られた店舗で最も生産性の高い売り場づくりを目指すことを「 」マーチャンダイジングという。", a: ["インストア"] },
    { id: 28, q: "我々の視覚に訴える店舗のレイアウトや品ぞろえ、什器や備品、POPなどの演出を「 」マーケティングという。", a: ["ヴィジュアル"] },
    { id: 29, q: "スーパーなどで一つのゴンドラの中で売り上げが最大になるような効果的な商品の棚割り計画のことを「 」という。", a: ["プラノグラム"] },
    { id: 30, q: "企業が必要な部品や製品を、必要な時に、必要な場所へ、必要な量だけ届ける配送システムのことを「 」・イン・タイム物流という。", a: ["ジャスト"] },
    { id: 31, q: "どこかで成功したビジネスアイデアを土台にして用いることを「 」という。", a: ["リアプライ"] },
    { id: 32, q: "「 」効果とは、ある製品・サービスを消費する人が多ければ多いほど顧客がその製品・サービスによって得る満足・安心感が増加する効果のことであり、「 」効果とは、他人と同じものは消費したくない、他人とは違うものが欲しいという心理のことである。", a: ["バンドワゴン", "スノッブ"] },
    { id: 34, q: "イノベーター理論では顧客の新製品や新サービスの購入頻度をもとに、「 」、「 」、「 」、「 」、「 」の5つのタイプに分類される。", a: ["イノベーター", "アーリーアダプター", "アーリーマジョリティ", "レイトマジョリティ", "ラガード"] },
    { id: 39, q: "バリューブレイクスルー戦略で、機能型→感性型という逆の価値観を取り入れ成功した企業は「 」である。", a: ["スターバックス"] },
    { id: 40, q: "競争とは関係ない広々とした市場空間を生み出して競争を無意味にする、全く新しい価値曲線を描く戦略のことを「 」戦略という。", a: ["ブルーオーシャン"] },
    { id: 41, q: "オンライン取引を利用することで企業は世界中の消費者をターゲットにすることができ、いわゆるベストセラーでない多様な製品の販売が可能になる。これを「 」効果という。", a: ["ロングテール"] },
    { id: 42, q: "オンライン取引の限界とは「 」、「 」、「 」、「 」である。", a: ["実見性", "応答性", "即時性", "団らん性"] },
    { id: 46, q: "ソーシャル・マーケティングは社会的マーケティングと訳すことができるが、コトラーのソーシャル・マーケティングは「 」のマーケティングとも呼ばれ、レイザーのソーシャル・マーケティングは「 」のマーケティングとも呼ばれる。", a: ["非営利組織", "社会志向"] },
    { id: 48, q: "企業の社会貢献マーケティングにおいて、文化支援活動を「 」、慈善行為を「 」と呼ぶ。", a: ["フィランソロピー", "メセナ"] },
    { id: 50, q: "「 」経営とは、「共有価値の創造」を軸とした経営のことです。", a: ["CSV"] }
];

const allKeywords = [...new Set(quizData.flatMap(d => d.a))].sort();

let state = { view: 'start', user: null, currentQuiz: [], index: 0, userChoices: {}, isLoginMode: false };

function render() {
    const app = document.getElementById('app');
    if (state.view === 'start') {
        app.innerHTML = `<h2>Marketing Quiz</h2>
            <button class="btn btn-main" onclick="showAuth(false)">初めて使う</button>
            <button class="btn btn-outline" style="margin-top:10px" onclick="showAuth(true)">使ったことがある</button>
            <div style="text-align:center; margin-top:20px"><a href="#" onclick="skipAuth()" style="color:var(--gray); font-size:0.9rem;">ログインせずに開始</a></div>`;
    } else if (state.view === 'auth') {
        app.innerHTML = `<h2>${state.isLoginMode ? 'ログイン' : '新規登録'}</h2>
            <input type="text" id="username" placeholder="名前">
            <input type="password" id="password" placeholder="パスワード">
            <div id="auth-msg" style="color:var(--error); font-size:0.8rem; height:20px; text-align:center;"></div>
            <button class="btn btn-main" onclick="handleAuth()">決定</button>
            <button class="btn" onclick="state.view='start'; render();">戻る</button>`;
    } else if (state.view === 'menu') {
        const hasHistory = state.user && Object.keys(state.user.stats || {}).length > 0;
        app.innerHTML = `<h2>こんにちは、${state.user ? state.user.name : 'ゲスト'}さん</h2>
            <div class="mode-group">
                <button class="btn btn-main" onclick="initQuiz('normal')">通常モード</button>
                <div class="mode-desc">全50問の中からランダムに10問出題されます。</div>
            </div>
            ${hasHistory ? `
            <div class="mode-group">
                <button class="btn btn-outline" onclick="initQuiz('weak')">苦手克服モード</button>
                <div class="mode-desc">過去の正答率が低い問題を優先的に選んで出題します。</div>
            </div>
            <div class="mode-group">
                <button class="btn btn-outline" onclick="initQuiz('efficient')">効率学習モード</button>
                <div class="mode-desc">正答率が80%を超えた「習得済み」の問題を除外して出題します。</div>
            </div>` : ''}
            <button class="btn" onclick="location.reload()" style="margin-top:20px; color:var(--error);">ログアウト / 終了</button>`;
    } else if (state.view === 'quiz') {
        const item = state.currentQuiz[state.index];
        let bIdx = 0;
        const formattedQ = item.q.replace(/「 」/g, () => {
            const val = (state.userChoices[state.index] && state.userChoices[state.index][bIdx]) || "";
            return `<span class="blank-box ${val ? 'filled' : ''}" onclick="openChoices(${bIdx++})">${val || "?"}</span>`;
        });
        app.innerHTML = `<div class="status-header"><span>第 ${state.index + 1} / 10 問</span><span>${state.user ? '正答率:' + getRate(item.id) + '%' : ''}</span></div>
            <div class="question-container"><div class="question-text">${formattedQ}</div><div class="hint-trigger" onclick="openHint()">?</div></div>
            <div class="nav-controls"><button class="btn btn-nav" onclick="prev()" ${state.index === 0 ? 'disabled' : ''}>← 前へ</button>
            <button class="btn btn-main btn-nav" onclick="next()">${state.index === 9 ? '採点する' : '次へ →'}</button></div>`;
    } else if (state.view === 'result') {
        const res = calculateScore();
        app.innerHTML = `<h2>結果: ${res.score} / 10</h2>
            <div style="overflow-y:auto; flex:1; margin-bottom:15px;">
                ${res.details.map((d, i) => `<div style="padding:10px; border-bottom:1px solid #eee; font-size:0.9rem;">
                    <b>問${i+1}:</b> ${d.isCorrect ? '✅' : '❌'}<br><small style="color:var(--gray)">正解: ${d.correctAnswers.join(' / ')}</small></div>`).join('')}
            </div><button class="btn btn-main" onclick="state.view='menu'; render();">メニューに戻る</button>`;
    }
}

// 共通ロジック
function showAuth(isLogin) { state.view = 'auth'; state.isLoginMode = isLogin; render(); }
function skipAuth() { state.user = null; state.view = 'menu'; render(); }
function handleAuth() {
    const n = document.getElementById('username').value.trim(), p = document.getElementById('password').value;
    if(!n || !p) return;
    let u = JSON.parse(localStorage.getItem('quiz_users') || '{}');
    if (state.isLoginMode) {
        if (u[n] && u[n].pass === p) { state.user = { name: n, ...u[n] }; state.view = 'menu'; }
        else { document.getElementById('auth-msg').innerText = "認証に失敗しました"; return; }
    } else {
        if (u[n]) { document.getElementById('auth-msg').innerText = "その名前は既に使われています"; return; }
        u[n] = { pass: p, stats: {} }; localStorage.setItem('quiz_users', JSON.stringify(u));
        state.user = { name: n, ...u[n] }; state.view = 'menu';
    }
    render();
}
function initQuiz(mode) {
    let pool = [...quizData];
    if (state.user) {
        if (mode === 'weak') pool.sort((a,b) => getRate(a.id) - getRate(b.id));
        else if (mode === 'efficient') {
            let filtered = pool.filter(a => getRate(a.id) < 80);
            if(filtered.length >= 5) pool = filtered;
        }
    }
    state.currentQuiz = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
    state.index = 0; state.userChoices = {}; state.view = 'quiz'; render();
}
function next() { if (state.index < 9) { state.index++; render(); } else { state.view = 'result'; render(); } }
function prev() { if (state.index > 0) { state.index--; render(); } }
function openChoices(idx) {
    const list = document.getElementById('choices-list'); list.innerHTML = "";
    const correct = state.currentQuiz[state.index].a[idx];
    let choices = [correct];
    while(choices.length < 6) {
        let d = allKeywords[Math.floor(Math.random() * allKeywords.length)];
        if(!choices.includes(d)) choices.push(d);
    }
    choices.sort().forEach(c => {
        const b = document.createElement('button'); b.className = 'choice-item'; b.innerText = c;
        b.onclick = () => { if(!state.userChoices[state.index]) state.userChoices[state.index] = []; state.userChoices[state.index][idx] = c; closeModal('choice-overlay'); render(); };
        list.appendChild(b);
    });
    document.getElementById('choice-overlay').style.display = 'flex';
}
function openHint() {
    const item = state.currentQuiz[state.index]; let i = 0;
    document.getElementById('hint-text').innerHTML = item.q.replace(/「 」/g, () => `<span style="color:var(--primary); font-weight:bold;">${item.a[i++]}</span>`);
    document.getElementById('hint-overlay').style.display = 'flex';
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function calculateScore() {
    let score = 0;
    const details = state.currentQuiz.map((item, qIdx) => {
        const uAns = state.userChoices[qIdx] || [];
        const isCorrect = item.a.every((val, i) => val === uAns[i]);
        if (isCorrect) score++;
        if (state.user) {
            if (!state.user.stats[item.id]) state.user.stats[item.id] = { c: 0, t: 0 };
            state.user.stats[item.id].t++; if (isCorrect) state.user.stats[item.id].c++;
            let u = JSON.parse(localStorage.getItem('quiz_users'));
            u[state.user.name].stats = state.user.stats; localStorage.setItem('quiz_users', JSON.stringify(u));
        }
        return { isCorrect, correctAnswers: item.a };
    });
    return { score, details };
}
function getRate(id) {
    if (!state.user || !state.user.stats[id]) return 0;
    const s = state.user.stats[id]; return Math.round((s.c / s.t) * 100);
}
render();
</script>
</body>
</html>
